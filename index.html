<!DOCTYPE html>
<html>
<head>
    <title>3D карта в A-Frame</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://aframe.io/releases/1.6.0/aframe-extras.min.js"></script>
    <style>
        .ui-element {
            font-size: 24px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            position: absolute;
            text-align: center;
        }
        #timer {
            top: 10px;
            left: 10px;
        }
        #score {
            top: 50px;
            left: 10px;
        }
        #restartButton {
            top: 90px;
            left: 10px;
            cursor: pointer;
            width: 200px;
        }
    </style>
</head>
<body>
    <a-scene>
        <a-assets>
            <a-asset-item id="mapModel" src="map.glb"></a-asset-item>
            <img id="squareTexture" src="https://i.imgur.com/mYmmbrp.jpg">
        </a-assets>
        <a-entity gltf-model="#mapModel" position="1 1 10" scale="6 6 6"></a-entity>

        <!-- Камера и управление движением -->
        <a-entity id="cameraRig" position="0 1.6 0">
            <a-entity id="playerCamera" camera look-controls></a-entity>
            <a-cursor color="yellow" fuse="false" raycaster="objects: .interactable"></a-cursor>

            <!-- Контроллеры -->
            <a-entity id="left-controller" laser-controls="hand: left" raycaster="objects: .interactable" vive-controls="hand: left" oculus-touch-controls="hand: left" windows-motion-controls="hand: left" daydream-controls="hand: left" gearvr-controls="hand: left" magicleap-controls="hand: left" position="-0.2 -0.2 -0.5" rotation="0 0 0">
                <a-entity class="laser" line="start: 0 0 0; end: 0 0 -10; color: white; opacity: 0.75;" position="0 0 0" rotation="0 0 0" visible="false"></a-entity>
            </a-entity>
            <a-entity id="right-controller" laser-controls="hand: right" raycaster="objects: .interactable" vive-controls="hand: right" oculus-touch-controls="hand: right" windows-motion-controls="hand: right" daydream-controls="hand: right" gearvr-controls="hand: right" magicleap-controls="hand: right" position="0.2 -0.2 -0.5" rotation="0 0 0">
                <a-entity class="laser" line="start: 0 0 0; end: 0 0 -10; color: white; opacity: 0.75;" position="0 0 0" rotation="0 0 0" visible="false"></a-entity>
            </a-entity>
        </a-entity>

        <a-light type="ambient" color="#FFF"></a-light>
        <a-light type="directional" position="-1 1 1" intensity="0.5"></a-light>

        <!-- Интерактивные объекты -->
        <a-box position="-4 1 -5" material="src: #squareTexture" class="interactable" scale="2 2 2" animation="property: position; to: -4 1.5 -5; dir: alternate; dur: 2000; loop: true"></a-box>
        <a-box position="0 1 -7" material="src: #squareTexture" class="interactable" scale="2 2 2" animation="property: position; to: 0 1.5 -7; dir: alternate; dur: 2000; loop: true"></a-box>
        <a-box position="4 1 -5" material="src: #squareTexture" class="interactable" scale="2 2 2" animation="property: position; to: 4 1.5 -5; dir: alternate; dur: 2000; loop: true"></a-box>

        <!-- UI Elements -->
        <a-plane id="timer" class="ui-element" position="-4 2 -3" rotation="0 -90 0" height="0.5" width="2" text="value: Таймер: 2:00; align: center;"></a-plane>
        <a-plane id="score" class="ui-element" position="-4 1.5 -3" rotation="0 -90 0" height="0.5" width="2" text="value: Счет: 0/3; align: center;"></a-plane>
        <a-plane id="restartButton" class="ui-element" position="-4 1 -3" rotation="0 -90 0" height="0.5" width="2" text="value: Перезапустить игру; align: center;" cursor-listener></a-plane>
    </a-scene>

    <script>
        let timer;
        let timeLeft = 120;
        let timerStarted = false;
        let score = 0;
        const totalCubes = 3;

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.querySelector('#timer').setAttribute('text', `value: Таймер: ${minutes}:${seconds < 10 ? '0' : ''}${seconds};`);
            if (timeLeft > 0) {
                timeLeft--;
            } else {
                clearInterval(timer);
                document.querySelector('#timer').setAttribute('text', 'value: Время вышло!;');
            }
        }

        function updateScore() {
            document.querySelector('#score').setAttribute('text', `value: Счет: ${score}/${totalCubes};`);
        }

        function handleCubeClick(box) {
            box.setAttribute('visible', 'false');
            score++;
            updateScore();
            if (score >= totalCubes) {
                clearInterval(timer);
                document.querySelector('#timer').setAttribute('text', 'value: Вы выиграли!;');
            }
        }

        function initCubes() {
            document.querySelectorAll('.interactable').forEach(box => {
                box.addEventListener('click', () => handleCubeClick(box));
            });
        }

        function initKeyPress() {
            document.addEventListener('keydown', (event) => {
                if (event.code === 'Space' && !timerStarted) {
                    timerStarted = true;
                    timer = setInterval(updateTimer, 1000);
                }
            });
        }

        function restartGame() {
            score = 0;
            timeLeft = 120;
            timerStarted = false;
            clearInterval(timer);
            updateScore();
            document.querySelector('#timer').setAttribute('text', 'value: Таймер: 2:00;');
            document.querySelectorAll('.interactable').forEach(box => {
                box.setAttribute('visible', 'true');
            });
            startTimer();
        }

        function startTimer() {
            if (!timerStarted) {
                timer = setInterval(updateTimer, 1000);
                timerStarted = true;
            }
        }

        window.onload = () => {
            updateTimer();
            updateScore();
            initCubes();
            initKeyPress();
            startTimer();

            // Обработка нажатий на контроллеры
            const cameraRig = document.querySelector('#cameraRig');
            const moveDistance = 0.1;

            // Функция для перемещения вперед или назад
            function moveForward(distance) {
                const direction = new THREE.Vector3();
                const camera = document.querySelector('#playerCamera').object3D;
                camera.getWorldDirection(direction);
                direction.y = 0; // Убираем вертикальную компоненту для движения по горизонтали
                cameraRig.object3D.position.add(direction.multiplyScalar(distance));
            }

            // Функция для перемещения назад
            function moveBackward(distance) {
                const direction = new THREE.Vector3();
                const camera = document.querySelector('#playerCamera').object3D;
                camera.getWorldDirection(direction);
                direction.y = 0; // Убираем вертикальную компоненту для движения по горизонтали
                cameraRig.object3D.position.sub(direction.multiplyScalar(distance));
            }

            // Обработчики событий нажатия на триггеры контроллеров
            document.querySelector('#left-controller').addEventListener('triggerdown', () => {
                moveForward(moveDistance);
            });

            document.querySelector('#right-controller').addEventListener('triggerdown', () => {
                moveBackward(moveDistance);
            });

            // Добавляем логику для показа лазерных указателей
            document.querySelectorAll('.laser').forEach(laser => {
                laser.components.line.updateLength();
                laser.setAttribute('visible', true);
            });

            // Обработчики событий нажатия на триггеры контроллеров
            document.querySelector('#left-controller').addEventListener('raycaster-intersection', (e) => {
                const intersections = e.detail.els;
                if (intersections.length > 0) {
                    const target = intersections[0];
                    if (target.classList.contains('interactable')) {
                        console.log('Left controller intersecting with:', target);
                        // Удаление объекта при нажатии на триггер
                        document.querySelector('#left-controller').addEventListener('triggerdown', () => {
                            handleCubeClick(target);
                        });
                    }
                }
            });

            document.querySelector('#right-controller').addEventListener('raycaster-intersection', (e) => {
                const intersections = e.detail.els;
                if (intersections.length > 0) {
                    const target = intersections[0];
                    if (target.classList.contains('interactable')) {
                        console.log('Right controller intersecting with:', target);
                        // Удаление объекта при нажатии на триггер
                        document.querySelector('#right-controller').addEventListener('triggerdown', () => {
                            handleCubeClick(target);
                        });
                    }
                }
            });

            // Обработчик события нажатия на кнопку перезапуска игры
            document.querySelector('#restartButton').addEventListener('click', () => {
                restartGame();
            });
        };
    </script>
</body>
</html>
