<!DOCTYPE html>
<html>
<head>
    <title>3D карта в A-Frame с физикой</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@4.2.0/dist/aframe-extras.min.js"></script>
    <style>
        /* Стили для обычного режима */
        #timer-html, #score-html, #restartButton-html {
            position: absolute;
            font-size: 24px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            display: block; /* Показываем в обычном режиме */
        }
    </style>
</head>
<body>
    <a-scene physics>
        <a-assets>
            <a-asset-item id="mapModel" src="map.glb"></a-asset-item>
            <img id="squareTexture" src="https://i.imgur.com/mYmmbrp.jpg">
            <audio id="collectSound" src="1.mp3"></audio>
        </a-assets>

        <!-- Модель карты -->
        <a-entity gltf-model="#mapModel" position="1 1 10" scale="6 6 6" static-body></a-entity>

        <!-- Контроллеры -->
        <a-entity id="left-controller" laser-controls="hand: left" raycaster="objects: .interactable" vive-controls="hand: left" oculus-touch-controls="hand: left" windows-motion-controls="hand: left" daydream-controls="hand: left" gearvr-controls="hand: left" magicleap-controls="hand: left"></a-entity>
        <a-entity id="right-controller" laser-controls="hand: right" raycaster="objects: .interactable" vive-controls="hand: right" oculus-touch-controls="hand: right" windows-motion-controls="hand: right" daydream-controls="hand: right" gearvr-controls="hand: right" magicleap-controls="hand: right"></a-entity>

        <!-- Камера и управление движением -->
        <a-entity id="cameraRig" position="0 1.6 0" kinematic-body>
            <a-entity id="playerCamera" camera look-controls wasd-controls></a-entity>
            <a-cursor color="yellow" fuse="false" raycaster="objects: .interactable"></a-cursor>
        </a-entity>

        <!-- Свет -->
        <a-light type="ambient" color="#FFF"></a-light>
        <a-light type="directional" position="-1 1 1" intensity="0.5"></a-light>

        <!-- Интерактивные объекты с физикой -->
        <a-box position="-4 1 -5" material="src: #squareTexture" class="interactable" scale="2 2 2" dynamic-body sound="on: bodyLoaded; src: #collectSound"></a-box>
        <a-box position="0 1 -7" material="src: #squareTexture" class="interactable" scale="2 2 2" dynamic-body sound="on: bodyLoaded; src: #collectSound"></a-box>
        <a-box position="4 1 -5" material="src: #squareTexture" class="interactable" scale="2 2 2" dynamic-body sound="on: bodyLoaded; src: #collectSound"></a-box>

        <!-- UI Elements для VR -->
        <a-text id="timer-vr" value="Таймер: 2:00" align="center" width="4" color="white" position="-4 2 -3" rotation="0 -90 0"></a-text>
        <a-text id="score-vr" value="Счет: 0/3" align="center" width="4" color="white" position="-4 1.5 -3" rotation="0 -90 0"></a-text>
        <a-text id="restartButton-vr" value="Перезапустить игру" align="center" width="4" color="white" position="-4 1 -3" rotation="0 -90 0" cursor-listener></a-text>

        <!-- UI Elements для обычного режима -->
        <div id="timer-html">Таймер: 2:00</div>
        <div id="score-html">Счет: 0/3</div>
        <div id="restartButton-html" onclick="restartGame()">Перезапустить игру</div>
    </a-scene>

    <script>
        let timer;
        let timeLeft = 120;
        let timerStarted = false;
        let score = 0;
        const totalCubes = 3;

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            const timerText = `Таймер: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            document.getElementById('timer-html').innerText = timerText;
            document.getElementById('timer-vr').setAttribute('value', timerText);

            if (timeLeft > 0) {
                timeLeft--;
            } else {
                clearInterval(timer);
                document.getElementById('timer-html').innerText = "Время вышло!";
                document.getElementById('timer-vr').setAttribute('value', 'Время вышло!');
            }
        }

        function updateScore() {
            const scoreText = `Счет: ${score}/${totalCubes}`;
            document.getElementById('score-html').innerText = scoreText;
            document.getElementById('score-vr').setAttribute('value', scoreText);
        }

        function handleCubeClick(box) {
            box.setAttribute('visible', 'false');
            box.components.body.remove(); // Удаляем физическое тело после сбора
            score++;
            updateScore();
            if (score >= totalCubes) {
                clearInterval(timer);
                document.getElementById('timer-html').innerText = "Вы выиграли!";
                document.getElementById('timer-vr').setAttribute('value', 'Вы выиграли!');
            }
        }

        function initCubes() {
            document.querySelectorAll('.interactable').forEach(box => {
                box.addEventListener('bodyLoaded', () => {
                    box.addEventListener('click', () => {
                        handleCubeClick(box);
                        const collectSound = document.getElementById('collectSound');
                        collectSound.currentTime = 0; // Перезапускаем звук
                        collectSound.play(); // Проигрываем звук при сборе
                    });
                });
            });
        }

        function restartGame() {
            score = 0;
            timeLeft = 120;
            timerStarted = false;
            clearInterval(timer);
            updateScore();
            document.getElementById('timer-html').innerText = `Таймер: 2:00`;
            document.getElementById('timer-vr').setAttribute('value', 'Таймер: 2:00');
            document.querySelectorAll('.interactable').forEach(box => {
                box.setAttribute('visible', 'true');
                box.components.body.add(); // Восстанавливаем физическое тело
            });
            startTimer();
        }

        function startTimer() {
            if (!timerStarted) {
                timer = setInterval(updateTimer, 1000);
                timerStarted = true;
            }
        }

        window.onload = () => {
            updateTimer();
            updateScore();
            initCubes();

            // Обработка нажатий на контроллеры
            const cameraRig = document.querySelector('#cameraRig');
            const moveDistance = 0.1;

            document.querySelector('#left-controller').addEventListener('triggerdown', () => {
                cameraRig.object3D.position.z += moveDistance;
            });

            document.querySelector('#right-controller').addEventListener('triggerdown', () => {
                cameraRig.object3D.position.z -= moveDistance;
            });

            // Обработчик события входа в VR
            document.querySelector('a-scene').addEventListener('enter-vr', () => {
                document.getElementById('timer-html').style.display = 'none';
                document.getElementById('score-html').style.display = 'none';
                document.getElementById('restartButton-html').style.display = 'none';

                document.getElementById('timer-vr').setAttribute('visible', true);
                document.getElementById('score-vr').setAttribute('visible', true);
                document.getElementById('restartButton-vr').setAttribute('visible', true);

                document.getElementById('restartButton-vr').addEventListener('click', () => {
                    restartGame();
                });
            });

            // Обработчик выхода из VR
            document.querySelector('a-scene').addEventListener('exit-vr', () => {
                document.getElementById('timer-html').style.display = 'block';
                document.getElementById('score-html').style.display = 'block';
                document.getElementById('restartButton-html').style.display = 'block';

                document.getElementById('timer-vr').setAttribute('visible', false);
                document.getElementById('score-vr').setAttribute('visible', false);
                document.getElementById('restartButton-vr').setAttribute('visible', false);
            });

            startTimer();
        };
    </script>
</body>
</html>
